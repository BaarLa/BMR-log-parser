<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chat Parser</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  input, textarea { width: 100%; margin-bottom: 10px; padding: 5px; }
  #chatOutput { white-space: pre-wrap; background: #f0f0f0; padding: 10px; border: 1px solid #ccc; max-height: 400px; overflow-y: auto; }
  button { padding: 10px 20px; margin-bottom: 10px; }
  label { font-weight: bold; }
</style>
</head>
<body>

<label for="player1">Character 1 name:</label>
<input type="text" id="player1" value="Player 1">

<label for="player2">Character 2 name:</label>
<input type="text" id="player2" value="Player 2">

<label for="htmlInput">HTML text:</label>
<textarea id="htmlInput" rows="15"></textarea>

<button id="parseBtn">Show log</button>

<label for="chatOutput">Result:</label>
<div id="chatOutput"></div>

<script>
function formatContent(contentSpan) {
    const classes = contentSpan.classList;
    const rawText = contentSpan.innerText.trim();

    if (classes.contains("ooc")) return `(${rawText})`;
    if (classes.contains("emote")) return `*${rawText}*`;

    const parts = [];
    contentSpan.childNodes.forEach(node => {
        if (node.nodeType === Node.TEXT_NODE) {
            const text = node.textContent.trim();
            if (text) parts.push(text);
        } else if (node.nodeType === Node.ELEMENT_NODE && node.tagName === "SPAN") {
            const cls = node.classList;
            const text = node.innerText.trim();
            if (!text) return;
            if (cls.contains("emote")) parts.push(`*${text}*`);
            else if (cls.contains("ooc")) parts.push(`(${text})`);
            else parts.push(text);
        }
    });
    return parts.join(" ");
}

function parseChat(players, html) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, "text/html");

    const dialog = doc.querySelector("ul#dialog");
    if (!dialog) return [];

    const chatBoxes = dialog.querySelectorAll("li.dialog_box.chat");
    const messages = [];

    chatBoxes.forEach((box, idx) => {
        const name = idx < players.length ? players[idx] : `Player ${idx + 1}`;
        const textField = box.querySelector("div.text_field");
        if (!textField) return;

        Array.from(textField.children).forEach(row => {
            const tsSpan = row.querySelector("span.timestamp");
            const contentSpan = row.querySelector("span.content");
            if (!tsSpan || !contentSpan) return;

            const timeStr = tsSpan.innerText.trim();
            const [h, m, s] = timeStr.split(":").map(Number);
            if (isNaN(h) || isNaN(m) || isNaN(s)) return;

            const timeObj = new Date();
            timeObj.setHours(h, m, s, 0);

            const text = formatContent(contentSpan);
            messages.push({ time: timeObj, line: `[${timeStr}] ${name}: ${text}` });
        });
    });

    messages.sort((a, b) => a.time - b.time);
    return messages.map(m => m.line);
}

document.getElementById("parseBtn").addEventListener("click", () => {
    const player1 = document.getElementById("player1").value.trim() || "Player 1";
    const player2 = document.getElementById("player2").value.trim() || "Player 2";
    const htmlInput = document.getElementById("htmlInput").value;

    const lines = parseChat([player1, player2], htmlInput);
    document.getElementById("chatOutput").textContent = lines.join("\n");
});
</script>

</body>
</html>
